function handleClientLoad(){gapi.load("client:auth2",initClient)}function initClient(){gapi.client.init({apiKey:API_KEY,clientId:CLIENT_ID,discoveryDocs:DISCOVERY_DOCS,scope:SCOPES}).then(function(){gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus),updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get()),authorizeButton.onclick=handleAuthClick})}function handleAuthClick(a){gapi.auth2.getAuthInstance().signIn()}function updateSigninStatus(a){a?(authorizeButton.style.display="none",gapi.client.request({path:CALENDAR_API+"/users/me/calendarList"}).execute(function(a,b){calendars=a.items;var c=$(".calendar .content .events"),d=new Date;db.ref("/profils/"+data.user+"/comptesGoogle/1/agendas").once("value").then(function(a){var b=0;a.val().forEach(function(e){gapi.client.calendar.events.list({calendarId:e,timeMin:new Date(d.getFullYear(),d.getMonth(),d.getDate()).toISOString(),showDeleted:!1,singleEvents:!0,maxResults:10,orderBy:"startTime"}).then(function(f){var g=f.result.items;if(g.length>0)for(q=0;q<g.length;q++){var h=g[q],i=h.start.dateTime;if(i){var j=h.end.dateTime,k=new Date(i),l=new Date(j),m=k.getFullYear()+"-"+(k.getMonth()+1)+"-"+k.getDate(),n=$("<p></p>");n.attr("data-begin-hour",k.getHours()+":"+k.getMinutes()),n.attr("data-end-hour",l.getHours()+":"+l.getMinutes()),n.text(h.summary);for(var o="#2D9CDB",p=0;p<calendars.length;p++)calendars[p].id==e&&(o=calendars[p].backgroundColor);n.attr("data-color",o),0===c.find('.day[data-date="'+m+'"]').length&&($day=$("<div></div>"),$day.attr("class","day"),$day.attr("data-date",m),c.append($day),agendaEvents.push(m)),c.find('.day[data-date="'+m+'"]').append(n)}}if(++b==a.val().filter(Boolean).length){agendaEvents.sort();for(var q=0;q<=2;q++){var r=d.addDays(q),s=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate();agendaEvents.includes(s)||(agendaEvents.push(s),agendaEvents.sort())}agendaEvents=agendaEvents.slice(0,3),displayEvents()}})})})})):authorizeButton.style.display="block"}!function(a){"use strict";a(document).on("ready",function(){})}(jQuery);var data={town:"Talence",carArea:{lat:44.8005254,lng:-.6040306,zoom:12},user:1},db,loadFirebase=function(){var a={apiKey:"AIzaSyDe5XDx3gXJNTmixrY8tqrJV_iMzdomNbc",authDomain:"meroir-77fc6.firebaseapp.com",databaseURL:"https://meroir-77fc6.firebaseio.com",projectId:"meroir-77fc6",storageBucket:"meroir-77fc6.appspot.com",messagingSenderId:"701589652709"};firebase.initializeApp(a),db=firebase.database()};loadFirebase();var initMap=function(){db.ref("/profils/"+data.user+"/transports/voiture").once("value").then(function(a){var b=a.val();if("true"==b.active){var c=new google.maps.Map(document.getElementById("map"),{zoom:b.zoom,center:{lat:b.lat,lng:b.lng},disableDefaultUI:!0}),d=new google.maps.TrafficLayer;d.setMap(c);var e=new google.maps.Map(document.getElementById("large-map"),{zoom:b.zoom+2.25,center:{lat:b.lat,lng:b.lng},disableDefaultUI:!0}),f=new google.maps.TrafficLayer;f.setMap(e)}})},CLIENT_ID="701589652709-am9gkbk9f16d01kks0vjp5fi09ka2s9c.apps.googleusercontent.com",API_KEY="AIzaSyDe5XDx3gXJNTmixrY8tqrJV_iMzdomNbc",DISCOVERY_DOCS=["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],CALENDAR_API="https://www.googleapis.com/calendar/v3",SCOPES="https://www.googleapis.com/auth/calendar.readonly",authorizeButton=document.getElementById("authorize-button"),displayEvents,agendaEvents=[];Date.prototype.addDays=function(a){var b=new Date(this.valueOf());return b.setDate(b.getDate()+a),b},Date.prototype.addHours=function(a){return this.setTime(this.getTime()+60*a*60*1e3),this},function(a){"use strict";var b,c,d=function(){var b=new Date,c=("0"+b.getHours()).slice(-2),d=("0"+b.getMinutes()).slice(-2);a(".time").html(c+":"+d);var e=["Dim.","Lun.","Mar.","Mer.","Jeu.","Ven.","Sam."],f=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];a(".clock .weekday").html(e[b.getDay()]),a(".clock .day").html(("0"+b.getDate()).slice(-2)),a(".clock .month").html(f[b.getMonth()])},e=function(){db.ref("/profils/"+data.user+"/localisation").once("value").then(function(b){var c=b.val();a(".weatherwidget-io-js, .weatherwidget-io-frame").remove(),a(".weatherwidget-io").attr("data-label_1",c.ville.toUpperCase());var d=a("<script></script>").attr("id","weatherwidget-io-js").attr("src","https://weatherwidget.io/js/widget.min.js");a("body").append(d)})},f=function(){a("#map").on("click",function(){a(".large-map-container").fadeIn(300)}),a(".map-cancel").on("click",function(){a(".large-map-container").fadeOut(300)})},g=function(){db.ref("/profils/"+data.user+"/transports/commun/arrets/").once("value").then(function(d){a(".schedules-container").empty(),b=[];var e=0;d.val().forEach(function(f){var j=encodeURIComponent(f.arret),k=f.direction.includes("_R")?f.ligne+"_R":f.ligne,l=encodeURIComponent(k),m="http://api.navitia.io/v1/coverage/fr-sw/routes/route%3A"+l+"/stop_areas/stop_area%3A"+j+"/stop_schedules?";a.ajax({url:m,headers:{Authorization:"Basic "+btoa("05d8f1d4-8189-4505-acdc-7cee1293d988")},success:function(f){var j=f.stop_schedules[0].stop_point.name,k="Dir. "+f.stop_schedules[0].route.direction.stop_area.name,l=f.stop_schedules[0].route.line.code,m="#"+f.stop_schedules[0].route.line.color,n='<article class="schedule" data-name="'+j+'"><div class="number" data-color="'+m+'"><span>'+l+"</span></div><h1>"+k+'</h1><p class="next-schedules"></p></article>';a(".schedules-container").append(n);for(var o=f.stop_schedules[0].date_times,p=o.length>2?2:o.length,q=0;q<p;q++){var r=o[q].date_time,s=r.split("T")[1],t=s.substr(0,2),u=s.substr(2,2);e in b||(b[e]={name:j,nextSchedules:[]}),b[e].nextSchedules.push({hours:t,minutes:u}),i()}++e==d.val().filter(Boolean).length&&(h(),c=setInterval(function(){var a=h(!0);a&&(clearInterval(c),g())},15e3))}})})})},h=function(c){c|=!1;for(var d=!1,e=0;e<b.length;e++)for(var f=0;f<b[e].nextSchedules.length;f++){var g=new Date,h=b[e].nextSchedules[f].hours,i=b[e].nextSchedules[f].minutes,j=new Date(g.getFullYear(),g.getMonth(),g.getDate(),h,i),k=j-g,l=Math.trunc(k/6e4);l<=0&&(l="< 1");var m=f>0?" | "+l+" min":l+" min",n=a('[data-name="'+b[e].name+'"]').find(".next-schedules");0==f&&n.empty(),k<3e4&&(d=!0),n.append(m)}return d},i=function(){a(".schedules-container .schedule").each(function(){a(this).find(".number").css("background",a(this).find(".number").attr("data-color"))})},j=function(){var b=a(".calendar .content .times");b.empty();for(var c=7;c<=23;c++){var d=("0"+c).slice(-2)+":00",e=a("<p></p>").text(d);b.append(e)}l()},k=function(){var b=a(".calendar .content .events"),c=b.attr("data-focused-date");b.find("p").hide();var d=b.find('.day[data-date="'+c+'"] p');d.each(function(){var b=a(this),c=b.attr("data-color"),e=b.attr("data-begin-hour"),f=e.split(":")[0],g=e.split(":")[1],h=b.attr("data-end-hour"),i=h.split(":")[0],j=h.split(":")[1],k=m(f,g)+1,l=m(i,j),n=l-k-1,o=0,p=0;d.each(function(){var c=a(this);c.is(b)&&(p=o);var d=c.attr("data-begin-hour"),e=d.split(":")[0],f=d.split(":")[1],g=c.attr("data-end-hour"),h=g.split(":")[0],i=g.split(":")[1],j=m(e,f),n=m(h,i);(k>=j&&l<=n||j>=k&&n<=l)&&o++});var q=100/o,r=p*q;b.css("background",c),b.css("top",k),b.css("height",n),b.css("marginLeft",r+"%"),b.css("width","calc("+q+"% - 1px)"),b.show()})},l=function(){var b=a(".calendar .content .current-time"),c=new Date,d=c.getHours(),e=c.getMinutes(),f=m(d,e);b.css("top",f)},m=function(a,b){var c=20+29*(a-7);return c+=29*b/60};displayEvents=function(){var b=0;r(agendaEvents[b]),k();var c=a(".calendar .leftBtn"),d=a(".calendar .rightBtn");c.hide(),agendaEvents.length<=1&&d.hide(),a(".clock .weekday").click(function(){--b<=0?(c.hide(),d.show()):(c.show(),d.show()),r(agendaEvents[b]),k()}),a(".clock .month").click(function(){++b>=agendaEvents.length-1?(c.show(),d.hide()):(c.show(),d.show()),r(agendaEvents[b]),k()})};var n,o,p,q,r=function(b){var c=a(".calendar .content .events"),d=["Dim.","Lun.","Mar.","Mer.","Jeu.","Ven.","Sam."],e=["Jan.","Fév.","Mars","Avr.","Mai","Juin","Juil.","Août","Sept.","Oct.","Nov.","Déc."],f=new Date(b),g=d[f.getDay()],h=("0"+f.getDate()).slice(-2),i=e[f.getMonth()];a(".calendar .titles h1").text(g+" "+h+" "+i),c.attr("data-focused-date",b);var j=new Date,k=("0"+j.getDate()).slice(-2),l=e[j.getMonth()],m=a(".calendar .current-time");k==h&&l==i?m.show():m.hide()},s=function(){var b=a(".loading h1");b.text("Reconnaissance faciale en cours..."),a(".loading").show();var c=new WebSocket("ws://169.254.132.122:8000/");c.onopen=function(){console.log("Opened connection facial server"),c.send("launch_recognition")},c.onmessage=function(b){console.log("Received: "+b.data),a(".loading").fadeOut(300);var d=a(".large-map-container");d.fadeOut(300),c.close()},c.onclose=function(){console.log("Closed connection"),n||t()},c.onerror=function(a){console.log("Error: "+a)}},t=function(){n=new WebSocket("ws://127.0.0.1:7000/"),n.onopen=function(){console.log("Opened connection voice server"),n.send("launch_recognition")},n.onmessage=function(b){var c=a(".calendar .leftBtn"),d=a(".calendar .rightBtn"),e=a(".large-map-container");console.log("Received: "+b.data),"aujourd_hui"==b.data?r(agendaEvents[0]):"trafic"==b.data?e.fadeIn(300):"fermer"==b.data?e.fadeOut(300):"jour_precedent"==b.data?focusedId-1>=0&&(0==--focusedId?(c.hide(),d.show()):(c.show(),d.show()),r(agendaEvents[focusedId]),k()):"jour_suivant"==b.data&&focusedId+1<=agendaEvents.length-1&&(++focusedId>=agendaEvents.length-1?(c.show(),d.hide()):(c.show(),d.show()),r(agendaEvents[focusedId]),k())},n.onclose=function(){console.log("Closed connection")},n.onerror=function(a){console.log("Error: "+a)}},u=function(){a(".blackout .content").fadeOut(300);var b=new WebSocket("ws://127.0.0.1:7070/");b.onopen=function(){console.log("Opened connection sonic server")},b.onmessage=function(a){console.log("Received: "+a.data),"start"==a.data?v():"shutdown"==a.data&&w()},b.onclose=function(){console.log("Closed connection")},b.onerror=function(a){console.log("Error: "+a)}},v=function(){s(),d(),o=setInterval(d,3e4),e(),p=setInterval(e,18e5),f(),g(),j(),q=setInterval(l,12e4),a(".blackout").fadeOut(300)},w=function(){a(".blackout").fadeIn(300),clearInterval(o),clearInterval(p),clearInterval(q)};a(document).ready(function(){setTimeout(u,3e4)})}(jQuery);var resetData=function(){firebase.database().ref("profils/1").set({comptesGoogle:{1:{adresse:"fmonniot@ensc.fr",agendas:{1:"fmonniot@ensc.fr",2:"9e3ntiluk6e3ljj950i3a2663fd8nr7s@import.calendar.google.com"}},2:{adresse:"fab.monniot@gmail.com",agendas:{1:"fab.monniot@gmail.com",2:"iplaa9979qbjukd62cs273c03s@group.calendar.google.com"}}},localisation:{geolocalisation:"false",cp:"33600",ville:"Pessac"},transports:{voiture:{lat:44.8005254,lng:-.6040306,zoom:12,active:"true"},commun:{active:"true",arrets:{1:{type:"bus",arret:"OBO:SA:BARDAN",ligne:"OBO:10",direction:"OBO:10"},2:{type:"bus",arret:"OBX:SA:DOYEN",ligne:"OBX:60",direction:"OBX:60"}}}},agendas:"true"})};!function(a){"use strict";a(document).on("ready",function(){})}(jQuery);